
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>中华白海豚科学与政策文本数据库</title>

<style>
:root{
  --bd:#cbd5e1;
  --muted:#52708a;
  --blue:#38bdf8;
  --deep:#0b4f75;
}

/* 海洋渐变背景 */
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",Arial;
  margin:0;
  padding:24px 16px;
  color:#0f172a;
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(56,189,248,.35), transparent 60%),
    radial-gradient(1000px 600px at 90% 0%, rgba(14,165,233,.25), transparent 55%),
    linear-gradient(180deg, #eaf6ff 0%, #f3fbff 35%, #ffffff 100%);
}

/* 主容器：雾面玻璃 */
.container{
  max-width:1000px;
  margin:0 auto;
  background:rgba(255,255,255,.72);
  border:1px solid rgba(203,213,225,.9);
  border-radius:18px;
  padding:20px 18px;
  backdrop-filter: blur(8px);
  box-shadow:0 12px 32px rgba(2,84,140,.08);
}

h1{
  margin:0 0 6px 0;
  font-size:28px;
  letter-spacing:.5px;
}
.sub{
  color:var(--muted);
  margin:0 0 18px 0;
}

/* 控件区 */
.bar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:14px;
}
select,input[type=text],button{
  padding:10px 12px;
  border:1px solid var(--bd);
  border-radius:10px;
  font-size:14px;
  background:rgba(255,255,255,.9);
}
input[type=text]{flex:1;min-width:220px}
button{cursor:pointer}
button:hover{background:#fff}

/* 年份范围条 */
.range-box{
  border:1px solid var(--bd);
  border-radius:12px;
  padding:12px 14px;
  margin-bottom:10px;
}
.range-title{
  font-size:13px;
  color:var(--muted);
  margin-bottom:8px;
}

.range-wrap{position:relative;height:28px}
.range-track{
  position:absolute;
  left:0;right:0;top:50%;
  height:4px;
  background:rgba(148,163,184,.4);
  border-radius:2px;
  transform:translateY(-50%);
}
.range-fill{
  position:absolute;
  top:50%;
  height:4px;
  background:linear-gradient(90deg, rgba(56,189,248,.35), rgba(56,189,248,.75));
  border-radius:2px;
  transform:translateY(-50%);
}
.range-wrap input[type=range]{
  position:absolute;
  left:0;right:0;top:0;bottom:0;
  pointer-events:none;
  appearance:none;
  background:none;
}
.range-wrap input::-webkit-slider-thumb{
  pointer-events:auto;
  appearance:none;
  width:16px;height:16px;
  border-radius:50%;
  background:#0ea5e9;
  border:2px solid #fff;
  box-shadow:0 0 0 1px #7dd3fc;
}
.range-wrap input::-moz-range-thumb{
  pointer-events:auto;
  width:16px;height:16px;
  border-radius:50%;
  background:#0ea5e9;
  border:none;
}

/* 列表淡入淡出（只在“最终刷新”时触发一次） */
#list{ transition:opacity 220ms ease; }
#list.is-updating{ opacity:.35; }

.stats{
  font-size:13px;
  color:var(--muted);
  margin:8px 0;
}

/* 卡片 */
.card{
  background:rgba(255,255,255,.78);
  border:1px solid rgba(203,213,225,.7);
  border-radius:14px;
  padding:12px 14px;
  margin:10px 0;
  box-shadow:0 6px 18px rgba(2,84,140,.06);
}
.title{font-weight:700;margin:0 0 6px 0}
.meta{font-size:13px;color:var(--muted);margin:0 0 8px 0}

.tag{
  display:inline-block;
  font-size:12px;
  background:rgba(56,189,248,.12);
  color:var(--deep);
  border-radius:999px;
  padding:2px 8px;
  margin:6px 6px 0 0;
}

a{color:#0284c7;text-decoration:none}
a:hover{text-decoration:underline}

.footer{
  margin-top:22px;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="container">

<h1>中华白海豚科学与政策文本数据库</h1>
<p class="sub">基于 GitHub Pages 的静态数据库（手动维护）</p>

<div class="bar">
  <select id="type"></select>
  <select id="country"></select>
  <input id="q" type="text" placeholder="搜索：标题 / 摘要 / 关键词 / 机构…" />
  <button id="exportBtn" type="button">导出 CSV</button>
</div>

<div class="range-box">
  <p class="range-title">
    年份范围：<b><span id="ymin"></span></b> — <b><span id="ymax"></span></b>
  </p>

  <div class="range-wrap">
    <div class="range-track"></div>
    <div class="range-fill" id="rangeFill"></div>
    <!-- 连续拖动（step 小），松手吸附整数 -->
    <input id="yearMin" type="range" step="0.01">
    <input id="yearMax" type="range" step="0.01">
  </div>
</div>

<div class="stats" id="stats"></div>
<div id="list"></div>

<div class="footer">
  编辑 <code>data.json</code> 后提交，页面会自动更新
</div>

</div>

<script>
async function loadData(){
  const r = await fetch("./data.json", { cache: "no-store" });
  if(!r.ok) throw new Error("无法加载 data.json（请确认与 index.html 同目录）");
  return await r.json();
}

const elType = document.getElementById("type");
const elCountry = document.getElementById("country");
const elQ = document.getElementById("q");
const exportBtn = document.getElementById("exportBtn");

const yearMin = document.getElementById("yearMin");
const yearMax = document.getElementById("yearMax");
const fill = document.getElementById("rangeFill");
const ymin = document.getElementById("ymin");
const ymax = document.getElementById("ymax");

const list = document.getElementById("list");
const stats = document.getElementById("stats");

let rows = [];
let lastFiltered = [];

/* 只对：类型/国家/搜索/松手吸附 触发列表刷新（200ms 缓冲） */
let renderTimer = null;
const DEBOUNCE_MS = 200;

function scheduleRender(){
  clearTimeout(renderTimer);
  renderTimer = setTimeout(() => renderListWithFade(), DEBOUNCE_MS);
}

const uniq = a => Array.from(new Set(a)).filter(Boolean);

function opt(label, value){
  const o = document.createElement("option");
  o.textContent = label;
  o.value = value;
  return o;
}

function buildFilters(){
  elType.innerHTML = "";
  elCountry.innerHTML = "";

  elType.appendChild(opt("全部类型", ""));
  uniq(rows.map(r => r.type)).forEach(v => elType.appendChild(opt(v, v)));

  elCountry.appendChild(opt("全部国家", ""));
  uniq(rows.map(r => r.country)).forEach(v => elCountry.appendChild(opt(v, v)));

  const ys = rows.map(r => Number(r.year)).filter(y => Number.isFinite(y) && y > 0);
  const minY = ys.length ? Math.min(...ys) : 1900;
  const maxY = ys.length ? Math.max(...ys) : new Date().getFullYear();

  yearMin.min = yearMax.min = minY;
  yearMin.max = yearMax.max = maxY;
  yearMin.value = minY;
  yearMax.value = maxY;

  updateRangeVisual();
}

function getYearBounds(){
  let a = Math.round(Number(yearMin.value));
  let b = Math.round(Number(yearMax.value));
  if(a > b) [a, b] = [b, a];
  return { a, b };
}

/* 只更新视觉（拖动时调用，不触发列表刷新） */
function updateRangeVisual(){
  if(Number(yearMin.value) > Number(yearMax.value)){
    const t = yearMin.value;
    yearMin.value = yearMax.value;
    yearMax.value = t;
  }

  const minVal = Number(yearMin.value);
  const maxVal = Number(yearMax.value);
  const minAll = Number(yearMin.min);
  const maxAll = Number(yearMin.max);
  const total = (maxAll - minAll) || 1;

  const left = ((minVal - minAll) / total) * 100;
  const right = ((maxVal - minAll) / total) * 100;

  fill.style.left = left + "%";
  fill.style.width = Math.max(0, right - left) + "%";

  const { a, b } = getYearBounds();
  ymin.textContent = a;
  ymax.textContent = b;
}

/* 松手：吸附到最近整数年，并触发一次列表刷新 */
function snapToInteger(){
  yearMin.value = String(Math.round(Number(yearMin.value)));
  yearMax.value = String(Math.round(Number(yearMax.value)));

  if(Number(yearMin.value) > Number(yearMax.value)){
    const t = yearMin.value;
    yearMin.value = yearMax.value;
    yearMax.value = t;
  }

  updateRangeVisual();
  scheduleRender();
}

function match(r){
  if(elType.value && r.type !== elType.value) return false;
  if(elCountry.value && r.country !== elCountry.value) return false;

  const { a, b } = getYearBounds();
  const y = Number(r.year);
  if(Number.isFinite(y)){
    if(y < a || y > b) return false;
  }

  const q = elQ.value.trim().toLowerCase();
  if(!q) return true;

  const hay = [
    r.type, r.title, r.org, r.country, String(r.year || ""),
    r.abstract, (r.tags || []).join(" "), r.link
  ].join(" ").toLowerCase();

  return hay.includes(q);
}

function renderListWithFade(){
  list.classList.add("is-updating");

  setTimeout(() => {
    lastFiltered = rows.filter(match);
    stats.textContent = `显示 ${lastFiltered.length} 条（共 ${rows.length} 条）`;

    list.innerHTML = "";
    for(const r of lastFiltered){
      const tagsHtml = (r.tags || []).map(t => `<span class="tag">${t}</span>`).join("");
      list.insertAdjacentHTML("beforeend", `
        <div class="card">
          <p class="title">[${r.type}] ${r.title}</p>
          <p class="meta">
            ${(r.org || "")}${r.org && r.year ? " · " : ""}${(r.year || "")}
            ${(r.org || r.year) && r.country ? " · " : ""}${(r.country || "")}
            ${r.link ? ` · <a href="${r.link}" target="_blank" rel="noopener">来源</a>` : ""}
          </p>
          <div>${r.abstract || ""}</div>
          <div>${tagsHtml}</div>
        </div>
      `);
    }

    requestAnimationFrame(() => list.classList.remove("is-updating"));
  }, 200);
}

/* CSV 导出（导出当前筛选结果） */
function csvEscape(v){
  const s = (v === null || v === undefined) ? "" : String(v);
  if(/[",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function exportCSV(){
  if(!lastFiltered.length){
    alert("当前筛选结果为空，无法导出。");
    return;
  }
  const header = ["类型","标题","机构/作者","国家/地区","年份","摘要/要点","关键词","链接"];
  const lines = [header.map(csvEscape).join(",")];

  for(const r of lastFiltered){
    const row = [
      r.type, r.title, r.org, r.country, r.year,
      r.abstract,
      Array.isArray(r.tags) ? r.tags.join(";") : (r.tags || ""),
      r.link
    ];
    lines.push(row.map(csvEscape).join(","));
  }

  const csv = "\ufeff" + lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const d = new Date();
  const pad = n => String(n).padStart(2, "0");
  const fname = `dolphin_db_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}.csv`;

  const a = document.createElement("a");
  a.href = url; a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

async function main(){
  rows = await loadData();
  rows.sort((a,b) => (Number(b.year||0)-Number(a.year||0)) || String(a.title).localeCompare(String(b.title), "zh"));

  buildFilters();
  renderListWithFade();

  // 类型/国家/搜索：需要刷新（带 200ms 缓冲）
  elType.addEventListener("change", scheduleRender);
  elCountry.addEventListener("change", scheduleRender);
  elQ.addEventListener("input", scheduleRender);

  // 年份：拖动只更新视觉；松手吸附并刷新（只闪一次）
  yearMin.addEventListener("input", updateRangeVisual);
  yearMax.addEventListener("input", updateRangeVisual);
  yearMin.addEventListener("change", snapToInteger);
  yearMax.addEventListener("change", snapToInteger);

  exportBtn.addEventListener("click", exportCSV);
}

main().catch(e => {
  stats.textContent = String(e.message || e);
});
</script>
</body>
</html>

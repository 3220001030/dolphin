<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>中华白海豚科学与政策文本数据库</title>

<style>
:root{
  --bd:#e5e7eb;
  --muted:#6b7280;
  --blue:#60a5fa;
}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",Arial;
  max-width:1000px;margin:24px auto;padding:0 16px;color:#111827;
}
h1{margin:0 0 6px 0;font-size:28px}
.sub{color:var(--muted);margin:0 0 16px 0}

.bar{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 12px
}
select,input[type=text],button{
  padding:10px 12px;border:1px solid var(--bd);
  border-radius:10px;font-size:14px;background:#fff
}
input[type=text]{flex:1;min-width:220px}
button{cursor:pointer}
button:hover{background:#f9fafb}

.range-box{
  border:1px solid var(--bd);
  border-radius:12px;
  padding:12px 14px;
  margin:0 0 10px 0;
}
.range-title{
  font-size:13px;color:var(--muted);margin:0 0 8px 0
}

/* ===== 单条范围滑块（两个端点） ===== */
.range-wrap{position:relative;height:28px}
.range-track{
  position:absolute;left:0;right:0;top:50%;
  height:4px;background:#e5e7eb;border-radius:2px;
  transform:translateY(-50%);
}
.range-fill{
  position:absolute;top:50%;height:4px;
  background:var(--blue);border-radius:2px;
  transform:translateY(-50%);
}
.range-wrap input[type=range]{
  position:absolute;left:0;right:0;top:0;bottom:0;
  pointer-events:none;
  appearance:none;background:none;
}
.range-wrap input::-webkit-slider-thumb{
  pointer-events:auto;
  appearance:none;
  width:16px;height:16px;border-radius:50%;
  background:#2563eb;border:2px solid #fff;
  box-shadow:0 0 0 1px #93c5fd;
}
.range-wrap input::-moz-range-thumb{
  pointer-events:auto;
  width:16px;height:16px;border-radius:50%;
  background:#2563eb;border:none;
}

/* ===== 列表淡入淡出（避免突兀） ===== */
#list{
  transition: opacity 180ms ease;
  opacity: 1;
}
#list.is-updating{opacity: 0.35;}

.stats{font-size:13px;color:var(--muted);margin:8px 0}

.card{
  border:1px solid var(--bd);
  border-radius:14px;padding:12px 14px;margin:10px 0;background:#fff
}
.title{font-weight:700;margin:0 0 6px 0}
.meta{font-size:13px;color:var(--muted);margin:0 0 8px 0}
.tag{
  display:inline-block;font-size:12px;
  background:#eff6ff;color:#1d4ed8;
  border-radius:999px;padding:2px 8px;margin-right:6px;margin-top:6px
}
a{color:#2563eb;text-decoration:none}
a:hover{text-decoration:underline}
.footer{margin:22px 0 10px;color:var(--muted);font-size:12px}
</style>
</head>

<body>
<h1>中华白海豚科学与政策文本数据库</h1>
<p class="sub">GitHub Pages 静态数据库（手动维护）</p>

<div class="bar">
  <select id="type"></select>
  <select id="country"></select>
  <input id="q" type="text" placeholder="搜索：标题 / 摘要 / 关键词 / 机构…" />
  <button id="exportBtn" type="button">导出 CSV</button>
</div>

<div class="range-box">
  <p class="range-title">
    年份范围：<b><span id="ymin"></span></b> — <b><span id="ymax"></span></b>
  </p>

  <div class="range-wrap">
    <div class="range-track"></div>
    <div class="range-fill" id="rangeFill"></div>
    <!-- step 小一点：拖动顺滑连续；筛选逻辑里再四舍五入成年份 -->
    <input id="yearMin" type="range" step="0.01">
    <input id="yearMax" type="range" step="0.01">
  </div>
</div>

<div class="stats" id="stats"></div>
<div id="list"></div>

<div class="footer">
  维护方式：编辑 <code>data.json</code> 增加条目并提交到仓库，页面会自动更新。
</div>

<script>
async function loadData(){
  const r = await fetch("./data.json", { cache: "no-store" });
  if(!r.ok) throw new Error("无法加载 data.json（请确认与 index.html 同目录，并已发布到 GitHub Pages）");
  return await r.json();
}

const elType = document.getElementById("type");
const elCountry = document.getElementById("country");
const elQ = document.getElementById("q");
const exportBtn = document.getElementById("exportBtn");

const yearMin = document.getElementById("yearMin");
const yearMax = document.getElementById("yearMax");
const fill = document.getElementById("rangeFill");
const ymin = document.getElementById("ymin");
const ymax = document.getElementById("ymax");

const list = document.getElementById("list");
const stats = document.getElementById("stats");

let rows = [];
let lastFiltered = [];

/** ====== 轻微缓冲：防止每次拖动/输入都瞬间“硬切” ======
 *  - 交互（滑块位置 + 蓝色区间）立即更新
 *  - 列表渲染做 debounce：用户停顿一小会儿再刷新（更丝滑）
 */
let renderTimer = null;
const RENDER_DEBOUNCE_MS = 120;

function scheduleRender(){
  clearTimeout(renderTimer);
  renderTimer = setTimeout(() => {
    renderListWithFade();
  }, RENDER_DEBOUNCE_MS);
}

const uniq = a => Array.from(new Set(a)).filter(Boolean);

function opt(label, value){
  const o = document.createElement("option");
  o.textContent = label;
  o.value = value;
  return o;
}

function buildFilters(){
  elType.innerHTML = "";
  elCountry.innerHTML = "";

  elType.appendChild(opt("全部类型", ""));
  uniq(rows.map(r => r.type)).forEach(v => elType.appendChild(opt(v, v)));

  elCountry.appendChild(opt("全部国家", ""));
  uniq(rows.map(r => r.country)).forEach(v => elCountry.appendChild(opt(v, v)));

  const ys = rows.map(r => Number(r.year)).filter(y => Number.isFinite(y) && y > 0);
  const minY = ys.length ? Math.min(...ys) : 1900;
  const maxY = ys.length ? Math.max(...ys) : new Date().getFullYear();

  yearMin.min = yearMax.min = minY;
  yearMin.max = yearMax.max = maxY;
  yearMin.value = minY;
  yearMax.value = maxY;

  updateRangeVisual(); // 立即更新
}

function getYearBounds(){
  // 交互可连续，但最终筛选按整数年
  let a = Math.round(Number(yearMin.value));
  let b = Math.round(Number(yearMax.value));
  if(a > b) [a, b] = [b, a];
  return { a, b };
}

function updateRangeVisual(){
  // 视觉层：thumb + fill 即时反馈
  // 这里仍用连续值来算 fill，让移动更丝滑
  if(Number(yearMin.value) > Number(yearMax.value)){
    const t = yearMin.value;
    yearMin.value = yearMax.value;
    yearMax.value = t;
  }

  const minVal = Number(yearMin.value);
  const maxVal = Number(yearMax.value);
  const minAll = Number(yearMin.min);
  const maxAll = Number(yearMin.max);
  const total = (maxAll - minAll) || 1;

  const left = ((minVal - minAll) / total) * 100;
  const right = ((maxVal - minAll) / total) * 100;

  fill.style.left = left + "%";
  fill.style.width = Math.max(0, right - left) + "%";

  // 显示层：用整数年
  const { a, b } = getYearBounds();
  ymin.textContent = a;
  ymax.textContent = b;
}

function match(r){
  if(elType.value && r.type !== elType.value) return false;
  if(elCountry.value && r.country !== elCountry.value) return false;

  const { a, b } = getYearBounds();
  const y = Number(r.year);
  if(Number.isFinite(y)){
    if(y < a || y > b) return false;
  }

  const q = elQ.value.trim().toLowerCase();
  if(!q) return true;

  const hay = [
    r.type, r.title, r.org, r.country, String(r.year || ""),
    r.abstract, (r.tags || []).join(" "), r.link
  ].join(" ").toLowerCase();

  return hay.includes(q);
}

function renderListWithFade(){
  // 列表淡出 → 更新 DOM → 淡入
  list.classList.add("is-updating");

  // “缓冲停留”时间（可改：80~200ms）
  setTimeout(() => {
    lastFiltered = rows.filter(match);
    stats.textContent = `显示 ${lastFiltered.length} 条（共 ${rows.length} 条）`;

    list.innerHTML = "";
    for(const r of lastFiltered){
      const tagsHtml = (r.tags || []).map(t => `<span class="tag">${t}</span>`).join("");
      list.insertAdjacentHTML("beforeend", `
        <div class="card">
          <p class="title">[${r.type}] ${r.title}</p>
          <p class="meta">
            ${(r.org || "")}${r.org && r.year ? " · " : ""}${(r.year || "")}
            ${(r.org || r.year) && r.country ? " · " : ""}${(r.country || "")}
            ${r.link ? ` · <a href="${r.link}" target="_blank" rel="noopener">来源</a>` : ""}
          </p>
          <div>${r.abstract || ""}</div>
          <div>${tagsHtml}</div>
        </div>
      `);
    }

    requestAnimationFrame(() => list.classList.remove("is-updating"));
  }, 120);
}

/* ===== CSV 导出 ===== */
function csvEscape(v){
  const s = (v === null || v === undefined) ? "" : String(v);
  if(/[",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function exportCSV(){
  if(!lastFiltered.length){
    alert("当前筛选结果为空，无法导出。");
    return;
  }
  const header = ["类型","标题","机构/作者","国家/地区","年份","摘要/要点","关键词","链接"];
  const lines = [header.map(csvEscape).join(",")];

  for(const r of lastFiltered){
    const row = [
      r.type, r.title, r.org, r.country, r.year,
      r.abstract,
      Array.isArray(r.tags) ? r.tags.join(";") : (r.tags || ""),
      r.link
    ];
    lines.push(row.map(csvEscape).join(","));
  }

  const csv = "\ufeff" + lines.join("\n"); // BOM: Excel 友好
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const d = new Date();
  const pad = n => String(n).padStart(2, "0");
  const fname = `dolphin_db_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}.csv`;

  const a = document.createElement("a");
  a.href = url; a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

async function main(){
  rows = await loadData();
  rows.sort((a,b) => (Number(b.year||0)-Number(a.year||0)) || String(a.title).localeCompare(String(b.title), "zh"));

  buildFilters();
  updateRangeVisual();
  renderListWithFade();

  // 事件：视觉立即更新，列表做 debounce
  elType.addEventListener("change", () => { updateRangeVisual(); scheduleRender(); });
  elCountry.addEventListener("change", () => { updateRangeVisual(); scheduleRender(); });
  elQ.addEventListener("input", () => { updateRangeVisual(); scheduleRender(); });

  yearMin.addEventListener("input", () => { updateRangeVisual(); scheduleRender(); });
  yearMax.addEventListener("input", () => { updateRangeVisual(); scheduleRender(); });

  exportBtn.addEventListener("click", exportCSV);
}

main().catch(e => {
  stats.textContent = String(e.message || e);
});
</script>
</body>
</html>

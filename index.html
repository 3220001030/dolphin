<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>中华白海豚科学与政策文本数据库</title>

<style>
:root{
  --bd:#e5e7eb;
  --muted:#6b7280;
  --blue:#60a5fa;
}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",Arial;
  max-width:1000px;margin:24px auto;padding:0 16px;color:#111827;
}
h1{margin-bottom:6px}
.sub{color:var(--muted);margin-bottom:16px}

.bar{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px
}
select,input[type=text],button{
  padding:10px 12px;border:1px solid var(--bd);
  border-radius:10px;font-size:14px;background:#fff
}
input[type=text]{flex:1;min-width:220px}
button{cursor:pointer}

.range-box{
  border:1px solid var(--bd);
  border-radius:12px;
  padding:12px 14px;
  margin-bottom:10px;
}
.range-title{
  font-size:13px;color:var(--muted);margin-bottom:8px
}

/* ===== 核心：单条范围滑块 ===== */
.range-wrap{
  position:relative;height:28px;
}
.range-track{
  position:absolute;left:0;right:0;top:50%;
  height:4px;background:#e5e7eb;border-radius:2px;
  transform:translateY(-50%);
}
.range-fill{
  position:absolute;top:50%;height:4px;
  background:var(--blue);border-radius:2px;
  transform:translateY(-50%);
}
.range-wrap input[type=range]{
  position:absolute;left:0;right:0;top:0;bottom:0;
  pointer-events:none;
  appearance:none;background:none;
}
.range-wrap input::-webkit-slider-thumb{
  pointer-events:auto;
  appearance:none;
  width:16px;height:16px;border-radius:50%;
  background:#2563eb;border:2px solid #fff;
  box-shadow:0 0 0 1px #93c5fd;
}
.range-wrap input::-moz-range-thumb{
  pointer-events:auto;
  width:16px;height:16px;border-radius:50%;
  background:#2563eb;border:none;
}

/* ===== 卡片 ===== */
.stats{font-size:13px;color:var(--muted);margin:8px 0}
.card{
  border:1px solid var(--bd);
  border-radius:14px;padding:12px 14px;margin-bottom:10px
}
.title{font-weight:700;margin-bottom:6px}
.meta{font-size:13px;color:var(--muted);margin-bottom:6px}
.tag{
  display:inline-block;font-size:12px;
  background:#eff6ff;color:#1d4ed8;
  border-radius:999px;padding:2px 8px;margin-right:6px
}
a{color:#2563eb;text-decoration:none}
a:hover{text-decoration:underline}
</style>
</head>

<body>
<h1>中华白海豚科学与政策文本数据库</h1>
<p class="sub">GitHub Pages 静态数据库</p>

<div class="bar">
  <select id="type"></select>
  <select id="country"></select>
  <input id="q" type="text" placeholder="搜索：标题 / 摘要 / 关键词 / 机构…" />
  <button id="exportBtn">导出 CSV</button>
</div>

<div class="range-box">
  <div class="range-title">
    年份范围：
    <b><span id="ymin"></span></b> —
    <b><span id="ymax"></span></b>
  </div>

  <div class="range-wrap">
    <div class="range-track"></div>
    <div class="range-fill" id="rangeFill"></div>
    <input id="yearMin" type="range">
    <input id="yearMax" type="range">
  </div>
</div>

<div class="stats" id="stats"></div>
<div id="list"></div>

<script>
async function loadData(){
  const r=await fetch("./data.json",{cache:"no-store"});
  return await r.json();
}

const elType=type, elCountry=country, elQ=q;
const yearMin=document.getElementById("yearMin");
const yearMax=document.getElementById("yearMax");
const fill=document.getElementById("rangeFill");
const ymin=document.getElementById("ymin");
const ymax=document.getElementById("ymax");
const list=document.getElementById("list");
const stats=document.getElementById("stats");

let rows=[], filtered=[];

const uniq=a=>[...new Set(a)].filter(Boolean);

function opt(t,v){const o=document.createElement("option");o.textContent=t;o.value=v;return o;}

function buildFilters(){
  elType.innerHTML=""; elCountry.innerHTML="";
  elType.appendChild(opt("全部类型",""));
  uniq(rows.map(r=>r.type)).forEach(v=>elType.appendChild(opt(v,v)));
  elCountry.appendChild(opt("全部国家",""));
  uniq(rows.map(r=>r.country)).forEach(v=>elCountry.appendChild(opt(v,v)));

  const ys=rows.map(r=>+r.year).filter(Boolean);
  const min=Math.min(...ys), max=Math.max(...ys);
  yearMin.min=yearMax.min=min;
  yearMin.max=yearMax.max=max;
  yearMin.value=min; yearMax.value=max;
  updateRange();
}

function updateRange(){
  if(+yearMin.value > +yearMax.value){
    [yearMin.value,yearMax.value]=[yearMax.value,yearMin.value];
  }
  const min=+yearMin.value, max=+yearMax.value;
  ymin.textContent=min; ymax.textContent=max;

  const total=yearMax.max-yearMin.min;
  const left=((min-yearMin.min)/total)*100;
  const right=((max-yearMin.min)/total)*100;
  fill.style.left=left+"%";
  fill.style.width=(right-left)+"%";
}

function match(r){
  if(elType.value && r.type!==elType.value) return false;
  if(elCountry.value && r.country!==elCountry.value) return false;
  if(r.year < yearMin.value || r.year > yearMax.value) return false;
  const q=elQ.value.trim().toLowerCase();
  if(!q) return true;
  return [r.title,r.abstract,r.org,r.tags].join(" ").toLowerCase().includes(q);
}

function render(){
  updateRange();
  filtered=rows.filter(match);
  stats.textContent=`显示 ${filtered.length} 条（共 ${rows.length} 条）`;
  list.innerHTML="";
  filtered.forEach(r=>{
    list.insertAdjacentHTML("beforeend",`
      <div class="card">
        <div class="title">[${r.type}] ${r.title}</div>
        <div class="meta">${r.org||""} · ${r.year} · ${r.country}
          ${r.link?`· <a href="${r.link}" target="_blank">来源</a>`:""}
        </div>
        <div>${r.abstract||""}</div>
        <div>${(r.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</div>
      </div>
    `);
  });
}

loadData().then(d=>{
  rows=d.sort((a,b)=>b.year-a.year);
  buildFilters(); render();
  [elType,elCountry,yearMin,yearMax].forEach(e=>e.oninput=render);
  elQ.oninput=render;
});
</script>
</body>
</html>

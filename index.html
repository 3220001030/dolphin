

<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>白海豚科学与政策文本数据库</title>

<style>
:root{
  --bd:#cbd5e1;
  --muted:#52708a;
  --blue:#38bdf8;
  --deep:#0b4f75;
}

body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",Arial;
  margin:0;
  padding:24px 16px;
  color:#0f172a;
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(56,189,248,.35), transparent 60%),
    radial-gradient(1000px 600px at 90% 0%, rgba(14,165,233,.25), transparent 55%),
    linear-gradient(180deg, #eaf6ff 0%, #f3fbff 35%, #ffffff 100%);
}

.container{
  max-width:1000px;
  margin:0 auto;
  background:rgba(255,255,255,.72);
  border:1px solid rgba(203,213,225,.9);
  border-radius:18px;
  padding:18px 18px 20px;
  backdrop-filter: blur(8px);
  box-shadow:0 12px 32px rgba(2,84,140,.08);
}

h1{ margin:0 0 6px 0; font-size:28px; letter-spacing:.5px; }
.sub{ color:var(--muted); margin:0 0 14px 0; }

/* 顶部选项卡 */
.tabs{
  display:flex; gap:10px; flex-wrap:wrap;
  margin:8px 0 16px;
}
.tabbtn{
  border:1px solid var(--bd);
  background:rgba(255,255,255,.85);
  border-radius:999px;
  padding:8px 12px;
  font-size:14px;
  cursor:pointer;
}
.tabbtn[aria-selected="true"]{
  border-color: rgba(56,189,248,.65);
  box-shadow:0 0 0 3px rgba(56,189,248,.18);
}

/* 面板淡入淡出（用于选项卡缓冲） */
.tabpanel{
  opacity:0;
  pointer-events:none;
  transition:opacity 200ms ease;
  display:none; /* 默认隐藏 */
}
.tabpanel.active{
  display:block;
  opacity:1;
  pointer-events:auto;
}
/* 离开态：仍显示但淡出（避免 display:none 立刻消失） */
.tabpanel.leaving{
  display:block;
  opacity:0;
  pointer-events:none;
}

/* 控件区 */
.bar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:14px;
}
select,input[type=text],button{
  padding:10px 12px;
  border:1px solid var(--bd);
  border-radius:10px;
  font-size:14px;
  background:rgba(255,255,255,.9);
}
input[type=text]{flex:1;min-width:220px}
button{cursor:pointer}
button:hover{background:#fff}

/* 年份范围条 */
.range-box{
  border:1px solid var(--bd);
  border-radius:12px;
  padding:12px 14px;
  margin-bottom:10px;
  background:rgba(255,255,255,.55);
}
.range-title{ font-size:13px; color:var(--muted); margin:0 0 8px 0; }

.range-wrap{position:relative;height:28px}
.range-track{
  position:absolute; left:0;right:0;top:50%;
  height:4px; background:rgba(148,163,184,.4);
  border-radius:2px; transform:translateY(-50%);
}
.range-fill{
  position:absolute; top:50%;
  height:4px;
  background:linear-gradient(90deg, rgba(56,189,248,.35), rgba(56,189,248,.75));
  border-radius:2px; transform:translateY(-50%);
}
.range-wrap input[type=range]{
  position:absolute; left:0;right:0;top:0;bottom:0;
  pointer-events:none; appearance:none; background:none;
}
.range-wrap input::-webkit-slider-thumb{
  pointer-events:auto; appearance:none;
  width:16px;height:16px;border-radius:50%;
  background:#0ea5e9;border:2px solid #fff;
  box-shadow:0 0 0 1px #7dd3fc;
}
.range-wrap input::-moz-range-thumb{
  pointer-events:auto;
  width:16px;height:16px;border-radius:50%;
  background:#0ea5e9;border:none;
}

/* 列表淡入淡出（只在最终刷新时触发一次） */
#list{ transition:opacity 220ms ease; }
#list.is-updating{ opacity:.35; }

.stats{ font-size:13px; color:var(--muted); margin:8px 0; }

/* 卡片 */
.card{
  background:rgba(255,255,255,.78);
  border:1px solid rgba(203,213,225,.7);
  border-radius:14px;
  padding:12px 14px;
  margin:10px 0;
  box-shadow:0 6px 18px rgba(2,84,140,.06);
}
.title{font-weight:700;margin:0 0 6px 0}
.meta{font-size:13px;color:var(--muted);margin:0 0 8px 0}
.tag{
  display:inline-block;
  font-size:12px;
  background:rgba(56,189,248,.12);
  color:var(--deep);
  border-radius:999px;
  padding:2px 8px;
  margin:6px 6px 0 0;
}

a{color:#0284c7;text-decoration:none}
a:hover{text-decoration:underline}

.footer{ margin-top:22px; font-size:12px; color:var(--muted); }

/* ===== 科学-政策接口可视化 ===== */
.viz-head{
  display:flex; gap:10px; flex-wrap:wrap; align-items:stretch;
  margin:6px 0 10px;
}
.kpi{
  flex:1;
  min-width:220px;
  border:1px solid rgba(203,213,225,.7);
  border-radius:14px;
  padding:12px 14px;
  background:rgba(255,255,255,.78);
  box-shadow:0 6px 18px rgba(2,84,140,.06);
}
.kpi .k{font-size:12px;color:var(--muted);margin:0}
.kpi .v{font-size:22px;font-weight:800;margin:2px 0 0}
.kpi .s{font-size:12px;color:var(--muted);margin:6px 0 0}

.viz-box{
  border:1px solid var(--bd);
  border-radius:12px;
  padding:12px 14px;
  background:rgba(255,255,255,.72);
}
.viz-title{
  margin:0 0 10px;
  font-weight:700;
}
.row{
  display:grid;
  grid-template-columns: 160px 1fr 90px;
  gap:10px;
  align-items:center;
  padding:8px 0;
  border-top:1px dashed rgba(203,213,225,.7);
}
.row:first-of-type{ border-top:none; }
.country-name{ font-weight:600; }
.barwrap{
  position:relative;
  height:10px;
  border-radius:999px;
  background:rgba(148,163,184,.25);
  overflow:hidden;
}
.barfill{
  height:100%;
  background:linear-gradient(90deg, rgba(56,189,248,.35), rgba(14,165,233,.85));
  width:0%;
}
.badge{
  justify-self:end;
  font-size:12px;
  border:1px solid rgba(203,213,225,.7);
  background:rgba(255,255,255,.75);
  border-radius:999px;
  padding:3px 8px;
  color:var(--deep);
}
.smallnote{ color:var(--muted); font-size:12px; margin:10px 0 0; }
.table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:13px;
}
.table th,.table td{
  padding:10px 8px;
  border-top:1px solid rgba(203,213,225,.7);
  text-align:left;
  vertical-align:top;
}
.table th{ color:var(--muted); font-weight:600; }
.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }


/* ===== 左侧筛选布局 ===== */
.db-layout{
  display:grid;
  grid-template-columns: 280px minmax(0,1fr);
  gap:16px;
  align-items:start;
}
.sidebar{
  position:sticky;
  top:16px;
  border:1px solid rgba(203,213,225,.8);
  border-radius:16px;
  padding:14px;
  background:rgba(255,255,255,.76);
  box-shadow:0 8px 22px rgba(2,84,140,.06);
}
.sidebar h3{
  margin:0 0 10px;
  font-size:15px;
}
.filter-group{
  margin-top:12px;
  padding-top:12px;
  border-top:1px dashed rgba(203,213,225,.8);
}
.filter-group:first-of-type{ margin-top:0; padding-top:0; border-top:none; }
.filter-title{
  margin:0 0 8px;
  font-size:13px;
  font-weight:700;
  color:var(--deep);
}
.filter-list{
  display:flex;
  flex-direction:column;
  gap:6px;
  max-height:180px;
  overflow:auto;
  padding-right:4px;
}
.filter-item{
  display:flex;
  align-items:flex-start;
  gap:8px;
  font-size:13px;
  line-height:1.35;
}
.filter-item input{ margin-top:2px; }
.filter-item .count{
  color:var(--muted);
  white-space:nowrap;
}
.filter-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  cursor:pointer;
  user-select:none;
}
.filter-toggle{
  border:none;
  background:transparent;
  padding:0;
  color:var(--deep);
  font-size:13px;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:space-between;
  width:100%;
  cursor:pointer;
}
.filter-toggle .caret{
  font-size:12px;
  color:var(--muted);
  transition:transform .16s ease;
}
.filter-group.collapsed .filter-toggle .caret{ transform:rotate(-90deg); }
.filter-search{
  width:100%;
  box-sizing:border-box;
  margin:0 0 8px 0;
  padding:8px 10px;
  font-size:12px;
  border-radius:9px;
}
.filter-body{ margin-top:8px; }
.filter-group.collapsed .filter-body{ display:none; }
.filter-item.is-disabled{ opacity:.48; }
.filter-item.is-disabled input{ pointer-events:none; }
.filter-item .count{ margin-left:auto; }
.selected-summary{
  margin:8px 0 0;
  font-size:12px;
  color:var(--muted);
}
.main-panel{ min-width:0; }
.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:14px;
}
.controls input[type=text]{ flex:1; min-width:220px; }
.muted-note{ color:var(--muted); font-size:12px; margin:6px 0 0; }
.card-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap:8px 12px;
  margin:8px 0;
}
.meta-block{ font-size:13px; }
.meta-label{ color:var(--muted); }
@media (max-width: 900px){
  .db-layout{ grid-template-columns: 1fr; }
  .sidebar{ position:static; }
}
</style>
</head>

<body>
<div class="container">

<h1>白海豚科学与政策文本数据库</h1>
<p class="sub">基于 GitHub Pages 的静态数据库（支持 data.json 多字段筛选）</p>

<div class="tabs" role="tablist" aria-label="页面选项卡">
  <button class="tabbtn" id="tab-db-btn" role="tab" aria-controls="tab-db" aria-selected="true">数据库</button>
  <button class="tabbtn" id="tab-spi-btn" role="tab" aria-controls="tab-spi" aria-selected="false">科学-政策接口</button>
</div>

<section id="tab-db" class="tabpanel active" role="tabpanel" aria-labelledby="tab-db-btn">
  <div class="range-box">
    <p class="range-title">
      年份范围：<b><span id="ymin"></span></b> — <b><span id="ymax"></span></b>
    </p>

    <div class="range-wrap">
      <div class="range-track"></div>
      <div class="range-fill" id="rangeFill"></div>
      <input id="yearMin" type="range" step="0.01">
      <input id="yearMax" type="range" step="0.01">
    </div>
  </div>

  <div class="db-layout">
    <aside class="sidebar">
      <h3>左侧筛选</h3>
      <div id="facetHost"></div>
      <button id="resetFiltersBtn" type="button">清空左侧筛选</button>
      <div id="selectedSummary" class="selected-summary">当前未选择左侧筛选</div>
      <p class="muted-note">每个选项显示动态剩余条目数；支持多选、分组折叠，并与顶部年份和搜索联动。</p>
    </aside>

    <div class="main-panel">
      <div class="controls">
        <input id="q" type="text" placeholder="搜索：标题 / 地区 / 分类 / 功能 / 备注…" />
        <button id="exportBtn" type="button">导出当前结果 CSV</button>
      </div>

      <div class="stats" id="stats"></div>
      <div id="list"></div>

      <div class="footer">
        编辑 <code>data.json</code> 后提交，页面会自动更新
      </div>
    </div>
  </div>
</section>

<section id="tab-spi" class="tabpanel" role="tabpanel" aria-labelledby="tab-spi-btn">
  <div class="viz-head">
    <div class="kpi">
      <p class="k">总体匹配指数</p>
      <p class="v" id="kpiScore">—</p>
      <p class="s">按国家/地区对齐：<span class="mono">min(论文数,政策数)/max(论文数,政策数)</span> 的加权平均</p>
    </div>
    <div class="kpi">
      <p class="k">覆盖国家/地区数</p>
      <p class="v" id="kpiCountries">—</p>
      <p class="s">统计 data.json 中出现过的国家/地区</p>
    </div>
    <div class="kpi">
      <p class="k">论文 vs 政策</p>
      <p class="v" id="kpiCounts">—</p>
      <p class="s">用来判断是“科研多政策少”还是相反</p>
    </div>
  </div>

  <div class="viz-box">
    <p class="viz-title">国家/地区维度匹配程度（越高越“科学-政策对齐”）</p>
    <div id="matchBars"></div>
    <p class="smallnote">
      解释：每个国家/地区计算 <span class="mono">match = min(Papers, Policies) / max(Papers, Policies)</span>（0–1），再显示为百分比。
      这不是“质量评价”，只是“数量层面的接口成熟度”指示器。
    </p>

    <table class="table" aria-label="国家/地区匹配明细表">
      <thead>
        <tr>
          <th>国家/地区</th>
          <th>论文数</th>
          <th>政策数</th>
          <th>匹配度</th>
          <th>建议（极简）</th>
        </tr>
      </thead>
      <tbody id="matchTable"></tbody>
    </table>
  </div>

  <div class="footer">
    提示：如果某国“政策=0”，可以先补充该国/地区的相关法规、行动计划、管理条例等条目（仍用同一 data.json 结构）。
  </div>
</section>

</div>

<script>
async function loadData(){
  const r = await fetch("./data.json", { cache: "no-store" });
  if(!r.ok) throw new Error("无法加载 data.json（请确认与 index.html 同目录）");
  return await r.json();
}

/* ======================
   选项卡逻辑（200ms 缓冲 + 淡入淡出）
   修复点：不再写任何 inline display:none
====================== */
const tabDbBtn = document.getElementById("tab-db-btn");
const tabSpiBtn = document.getElementById("tab-spi-btn");
const tabDb = document.getElementById("tab-db");
const tabSpi = document.getElementById("tab-spi");

const TAB_DELAY = 200;
let tabTimer = null;

function setAriaSelected(which){
  const isDb = which === "db";
  tabDbBtn.setAttribute("aria-selected", String(isDb));
  tabSpiBtn.setAttribute("aria-selected", String(!isDb));
}

function showPanel(which){
  const isDb = which === "db";
  tabDb.classList.toggle("active", isDb);
  tabSpi.classList.toggle("active", !isDb);
}

function switchTabBuffered(which){
  clearTimeout(tabTimer);

  const targetIsDb = which === "db";
  if(targetIsDb && tabDb.classList.contains("active")) return;
  if(!targetIsDb && tabSpi.classList.contains("active")) return;

  const from = targetIsDb ? tabSpi : tabDb;
  const to   = targetIsDb ? tabDb  : tabSpi;

  // 先淡出当前页（保持 display:block），200ms 后切换到目标页
  from.classList.add("leaving");

  setAriaSelected(which);
  location.hash = targetIsDb ? "#db" : "#spi";

  tabTimer = setTimeout(() => {
    from.classList.remove("active");
    from.classList.remove("leaving");

    to.classList.remove("leaving");
    to.classList.add("active");
  }, TAB_DELAY);
}

tabDbBtn.addEventListener("click", () => switchTabBuffered("db"));
tabSpiBtn.addEventListener("click", () => switchTabBuffered("spi"));

// 初始 hash：加载时直接显示目标页（不加缓冲，避免首屏空白）
if(location.hash === "#spi"){
  setAriaSelected("spi");
  showPanel("spi");
} else {
  setAriaSelected("db");
  showPanel("db");
}

/* ======================
   数据库页（适配当前 data.json 字段）
====================== */
const elQ = document.getElementById("q");
const exportBtn = document.getElementById("exportBtn");
const resetFiltersBtn = document.getElementById("resetFiltersBtn");
const facetHost = document.getElementById("facetHost");

const yearMin = document.getElementById("yearMin");
const yearMax = document.getElementById("yearMax");
const fill = document.getElementById("rangeFill");
const ymin = document.getElementById("ymin");
const ymax = document.getElementById("ymax");

const list = document.getElementById("list");
const stats = document.getElementById("stats");

let rows = [];
let lastFiltered = [];
let renderTimer = null;
const DEBOUNCE_MS = 200;

const FACETS = [
  { key: "jurisdiction", label: "适用层级" },
  { key: "country_or_region", label: "国家/地区" },
  { key: "document_type", label: "文本类型" },
  { key: "targeting_category", label: "针对性分类" },
  { key: "language", label: "语种" },
  { key: "hierarchy_level", label: "法律层级" }
];

const facetSelections = Object.fromEntries(FACETS.map(f => [f.key, new Set()]));
const facetSearchTerms = Object.fromEntries(FACETS.map(f => [f.key, ""]));
const facetCollapsed = Object.fromEntries(FACETS.map(f => [f.key, false]));
const selectedSummary = document.getElementById("selectedSummary");

function scheduleRender(){
  clearTimeout(renderTimer);
  renderTimer = setTimeout(() => renderAll(), DEBOUNCE_MS);
}

function norm(v){
  if(v === null || v === undefined) return "";
  return String(v).trim();
}

function escapeHtml(v){
  return String(v ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', '&quot;');
}

function getFacetValues(key){
  const m = new Map();
  for(const r of rows){
    const v = norm(r[key]);
    if(!v) continue;
    m.set(v, (m.get(v) || 0) + 1);
  }
  return Array.from(m.entries()).sort((a,b) => b[1]-a[1] || a[0].localeCompare(b[0], "zh"));
}

function buildFacetUI(){
  facetHost.innerHTML = "";
  for(const facet of FACETS){
    const group = document.createElement("section");
    group.className = "filter-group" + (facetCollapsed[facet.key] ? " collapsed" : "");
    group.dataset.facetGroup = facet.key;

    const values = getFacetValues(facet.key);
    const items = values.map(([value], idx) => {
      const id = `facet-${facet.key}-${idx}`;
      const checked = facetSelections[facet.key].has(value) ? 'checked' : '';
      return `
        <label class="filter-item" for="${id}" data-facet-item="${facet.key}" data-value="${escapeHtml(value)}">
          <input type="checkbox" id="${id}" data-facet="${facet.key}" value="${escapeHtml(value)}" ${checked}>
          <span class="facet-text">${escapeHtml(value)}</span>
          <span class="count">(0)</span>
        </label>
      `;
    }).join("");

    group.innerHTML = `
      <div class="filter-head">
        <button class="filter-toggle" type="button" data-toggle-facet="${facet.key}" aria-expanded="${facetCollapsed[facet.key] ? 'false' : 'true'}">
          <span>${facet.label}</span>
          <span class="caret">▾</span>
        </button>
      </div>
      <div class="filter-body">
        <input class="filter-search" type="text" data-facet-search="${facet.key}" placeholder="筛选${facet.label}…" value="${escapeHtml(facetSearchTerms[facet.key] || "")}">
        <div class="filter-list">${items || '<span class="muted-note">无可用选项</span>'}</div>
      </div>
    `;
    facetHost.appendChild(group);
  }

  facetHost.querySelectorAll('button[data-toggle-facet]').forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.dataset.toggleFacet;
      facetCollapsed[key] = !facetCollapsed[key];
      const group = facetHost.querySelector(`[data-facet-group="${key}"]`);
      group?.classList.toggle("collapsed", facetCollapsed[key]);
      btn.setAttribute("aria-expanded", String(!facetCollapsed[key]));
    });
  });

  facetHost.querySelectorAll('input[type="checkbox"][data-facet]').forEach(box => {
    box.addEventListener("change", () => {
      const key = box.dataset.facet;
      if(box.checked) facetSelections[key].add(box.value);
      else facetSelections[key].delete(box.value);
      scheduleRender();
    });
  });

  facetHost.querySelectorAll('input[data-facet-search]').forEach(inp => {
    inp.addEventListener("input", () => {
      facetSearchTerms[inp.dataset.facetSearch] = inp.value.trim().toLowerCase();
      refreshFacetStates();
    });
  });
}

function getYearBounds(){
  let a = Math.round(Number(yearMin.value));
  let b = Math.round(Number(yearMax.value));
  if(a > b) [a, b] = [b, a];
  return { a, b };
}

function updateRangeVisual(){
  if(Number(yearMin.value) > Number(yearMax.value)){
    const t = yearMin.value;
    yearMin.value = yearMax.value;
    yearMax.value = t;
  }

  const minVal = Number(yearMin.value);
  const maxVal = Number(yearMax.value);
  const minAll = Number(yearMin.min);
  const maxAll = Number(yearMin.max);
  const total = (maxAll - minAll) || 1;

  const left = ((minVal - minAll) / total) * 100;
  const right = ((maxVal - minAll) / total) * 100;

  fill.style.left = left + "%";
  fill.style.width = Math.max(0, right - left) + "%";

  const { a, b } = getYearBounds();
  ymin.textContent = a;
  ymax.textContent = b;
}

function snapToInteger(){
  yearMin.value = String(Math.round(Number(yearMin.value)));
  yearMax.value = String(Math.round(Number(yearMax.value)));

  if(Number(yearMin.value) > Number(yearMax.value)){
    const t = yearMin.value;
    yearMin.value = yearMax.value;
    yearMax.value = t;
  }

  updateRangeVisual();
  scheduleRender();
}

function buildFilters(){
  const ys = rows.map(r => Number(r.year)).filter(y => Number.isFinite(y) && y > 0);
  const minY = ys.length ? Math.min(...ys) : 1900;
  const maxY = ys.length ? Math.max(...ys) : new Date().getFullYear();

  yearMin.min = yearMax.min = minY;
  yearMin.max = yearMax.max = maxY;
  yearMin.value = minY;
  yearMax.value = maxY;

  updateRangeVisual();
  buildFacetUI();
}

function matchesFacet(r, ignoreKey = null){
  return FACETS.every(facet => {
    if(ignoreKey && facet.key === ignoreKey) return true;
    const selected = facetSelections[facet.key];
    if(!selected || selected.size === 0) return true;
    return selected.has(norm(r[facet.key]));
  });
}

function matchesYearAndSearch(r){
  const { a, b } = getYearBounds();
  const y = Number(r.year);
  if(Number.isFinite(y) && (y < a || y > b)) return false;

  const q = elQ.value.trim().toLowerCase();
  if(!q) return true;

  const hay = [
    r.document_title, r.document_type, r.country_or_region, r.subnational_area,
    r.jurisdiction, r.language, r.hierarchy_level, r.targeting_category,
    r.function_type, r.taxon_label_used_in_text, r.notes, r.source_url, String(r.year || "")
  ].map(norm).join(" ").toLowerCase();

  return hay.includes(q);
}

function match(r){
  return matchesFacet(r) && matchesYearAndSearch(r);
}

function getDynamicCount(facetKey, value){
  let count = 0;
  for(const r of rows){
    if(norm(r[facetKey]) !== value) continue;
    if(!matchesFacet(r, facetKey)) continue;
    if(!matchesYearAndSearch(r)) continue;
    count += 1;
  }
  return count;
}

function refreshSelectedSummary(){
  const parts = [];
  for(const facet of FACETS){
    const selected = Array.from(facetSelections[facet.key]);
    if(!selected.length) continue;
    parts.push(`${facet.label}：${selected.join('、')}`);
  }
  selectedSummary.textContent = parts.length ? `当前筛选：${parts.join(' ｜ ')}` : '当前未选择左侧筛选';
}

function refreshFacetStates(){
  refreshSelectedSummary();
  for(const facet of FACETS){
    const searchTerm = (facetSearchTerms[facet.key] || "").toLowerCase();
    const selectedSet = facetSelections[facet.key];
    const labels = facetHost.querySelectorAll(`[data-facet-item="${facet.key}"]`);
    labels.forEach(label => {
      const value = label.dataset.value || "";
      const visible = !searchTerm || value.toLowerCase().includes(searchTerm);
      label.style.display = visible ? "flex" : "none";

      const count = getDynamicCount(facet.key, value);
      const isSelected = selectedSet.has(value);
      const countEl = label.querySelector('.count');
      if(countEl) countEl.textContent = `(${count})`;

      const box = label.querySelector('input[type="checkbox"]');
      if(box){
        box.checked = isSelected;
        box.disabled = !isSelected && count === 0;
      }
      label.classList.toggle('is-disabled', !isSelected && count === 0);
    });
  }
}

function renderListWithFade(){
  list.classList.add("is-updating");

  setTimeout(() => {
    lastFiltered = rows.filter(match);
    stats.textContent = `显示 ${lastFiltered.length} 条（共 ${rows.length} 条）`;

    list.innerHTML = "";
    for(const r of lastFiltered){
      const functionTags = norm(r.function_type).split(";").map(s => s.trim()).filter(Boolean);
      const tagsHtml = [
        r.targeting_category && `<span class="tag">分类 ${escapeHtml(r.targeting_category)}</span>`,
        r.language && `<span class="tag">${escapeHtml(r.language)}</span>`,
        ...functionTags.map(t => `<span class="tag">${escapeHtml(t)}</span>`)
      ].filter(Boolean).join("");

      const area = [norm(r.country_or_region), norm(r.subnational_area)].filter(Boolean).join(" · ");
      list.insertAdjacentHTML("beforeend", `
        <div class="card">
          <p class="title">[${escapeHtml(norm(r.document_type) || "未分类")}] ${escapeHtml(norm(r.document_title) || "未命名文本")}</p>
          <div class="card-grid">
            <div class="meta-block"><span class="meta-label">地区：</span>${escapeHtml(area || "未标注")}</div>
            <div class="meta-block"><span class="meta-label">年份：</span>${escapeHtml(norm(r.year) || "未标注")}</div>
            <div class="meta-block"><span class="meta-label">适用层级：</span>${escapeHtml(norm(r.jurisdiction) || "未标注")}</div>
            <div class="meta-block"><span class="meta-label">法律层级：</span>${escapeHtml(norm(r.hierarchy_level) || "未标注")}</div>
            <div class="meta-block"><span class="meta-label">分类名：</span>${escapeHtml(norm(r.taxon_label_used_in_text) || "未标注")}</div>
            <div class="meta-block"><span class="meta-label">链接：</span>${r.source_url ? `<a href="${escapeHtml(r.source_url)}" target="_blank" rel="noopener">来源</a>` : "无"}</div>
          </div>
          ${r.notes ? `<div class="meta" style="margin-top:6px">备注：${escapeHtml(r.notes)}</div>` : ""}
          <div>${tagsHtml}</div>
        </div>
      `);
    }

    requestAnimationFrame(() => list.classList.remove("is-updating"));
  }, 200);
}

function renderAll(){
  refreshFacetStates();
  renderListWithFade();
}

function csvEscape(v){
  const s = (v === null || v === undefined) ? "" : String(v);
  if(/[",

]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function exportCSV(){
  if(!lastFiltered.length){
    alert("当前筛选结果为空，无法导出。");
    return;
  }
  const header = [
    "id","jurisdiction","country_or_region","subnational_area","language","year",
    "document_title","document_type","hierarchy_level","targeting_category",
    "function_type","taxon_label_used_in_text","source_url","notes"
  ];
  const lines = [header.map(csvEscape).join(",")];

  for(const r of lastFiltered){
    const row = header.map(k => r[k]);
    lines.push(row.map(csvEscape).join(","));
  }

  const csv = "﻿" + lines.join("
");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const d = new Date();
  const pad = n => String(n).padStart(2, "0");
  const fname = `white_dolphin_filtered_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}.csv`;

  const a = document.createElement("a");
  a.href = url; a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}
/* ======================
   科学-政策接口可视化（SPI）
====================== */
const kpiScore = document.getElementById("kpiScore");
const kpiCountries = document.getElementById("kpiCountries");
const kpiCounts = document.getElementById("kpiCounts");
const matchBars = document.getElementById("matchBars");
const matchTable = document.getElementById("matchTable");

function computeSPI(allRows){
  const byCountry = new Map();

  for(const r of allRows){
    const c = (r.country_or_region || "未标注").trim();
    if(!byCountry.has(c)) byCountry.set(c, {country:c, papers:0, policies:0});
    const obj = byCountry.get(c);
    const type = String(r.document_type || "");
    const isPaper = type.includes("论文") || type.toLowerCase() === "paper";
    if(isPaper) obj.papers += 1;
    else obj.policies += 1;
  }

  const arr = Array.from(byCountry.values()).map(d=>{
    const p = d.papers, s = d.policies;
    const denom = Math.max(p,s);
    const match = denom === 0 ? 0 : Math.min(p,s)/denom;
    const weight = p + s;
    return {...d, match, weight};
  });

  const totalW = arr.reduce((a,b)=>a+b.weight, 0) || 1;
  const overall = arr.reduce((a,b)=>a + b.match*b.weight, 0) / totalW;

  return {arr, overall};
}

function renderSPI(){
  const {arr, overall} = computeSPI(rows);
  const countries = arr.length;
  const totalP = arr.reduce((a,b)=>a+b.papers, 0);
  const totalS = arr.reduce((a,b)=>a+b.policies, 0);

  kpiScore.textContent = Math.round(overall*100) + "%";
  kpiCountries.textContent = String(countries);
  kpiCounts.textContent = `${totalP} / ${totalS}`;

  const sorted = [...arr].sort((a,b)=> (b.match-a.match) || (b.weight-a.weight) || a.country.localeCompare(b.country,"zh"));

  matchBars.innerHTML = "";
  matchTable.innerHTML = "";

  for(const d of sorted){
    const pct = Math.round(d.match*100);
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="country-name">${d.country}</div>
      <div class="barwrap"><div class="barfill" style="width:${pct}%;"></div></div>
      <div class="badge">${pct}%</div>
    `;
    matchBars.appendChild(row);

    let suggestion = "均衡（可深化内容质量）";
    if(d.papers>0 && d.policies===0) suggestion = "缺政策：补行动计划/法规/条例";
    if(d.policies>0 && d.papers===0) suggestion = "缺科研：补监测/评估研究";
    if(d.papers>0 && d.policies>0 && d.match < 0.5) suggestion = "不均衡：补齐薄弱侧";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.country}</td>
      <td>${d.papers}</td>
      <td>${d.policies}</td>
      <td>${pct}%</td>
      <td>${suggestion}</td>
    `;
    matchTable.appendChild(tr);
  }
}

async function main(){
  rows = await loadData();
  rows.sort((a,b) => (Number(b.year||0)-Number(a.year||0)) || String(a.document_title || "").localeCompare(String(b.document_title || ""), "zh"));

  buildFilters();
  renderAll();
  renderSPI();

  elQ.addEventListener("input", scheduleRender);
  resetFiltersBtn.addEventListener("click", () => {
    Object.values(facetSelections).forEach(set => set.clear());
    Object.keys(facetSearchTerms).forEach(k => facetSearchTerms[k] = "");
    facetHost.querySelectorAll('input[type="checkbox"]').forEach(box => box.checked = false);
    facetHost.querySelectorAll('input[data-facet-search]').forEach(inp => inp.value = "");
    refreshFacetStates();
    scheduleRender();
  });

  yearMin.addEventListener("input", updateRangeVisual);
  yearMax.addEventListener("input", updateRangeVisual);
  yearMin.addEventListener("change", snapToInteger);
  yearMax.addEventListener("change", snapToInteger);

  exportBtn.addEventListener("click", exportCSV);
}

main().catch(e => {
  stats.textContent = String(e.message || e);
});
</script>
</body>
</html>
